<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaskMaster Pro - å…¨ç«¯è‡ªå®šç¾©ä»»å‹™ç³»çµ±</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #64748b;
            --bg: #f3f4f6; --card-bg: #ffffff; --text: #1e293b; --border: #e2e8f0; --accent: #eff6ff;
            --danger: #ef4444;
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; touch-action: pan-y; }
        
        /* Header */
        header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 0 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 60px; }
        .logo { font-size: 18px; font-weight: 800; color: var(--primary); }
        .tabs { display: flex; gap: 4px; }
        .tab-btn { padding: 8px 12px; cursor: pointer; border: none; background: transparent; font-weight: 600; color: var(--secondary); border-radius: 6px; font-size: 14px; }
        .tab-btn.active { background: var(--accent); color: var(--primary); }

        /* Main */
        .main-content { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* è¡¨æ ¼èˆ‡è¡¨å–® */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead th { background: #f8fafc; padding: 12px; text-align: left; font-size: 13px; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #475569; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 16px; } /* 16px é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */

        /* å±¬æ€§é…ç½®å¡ç‰‡ (å„ªåŒ–è¡Œå‹•ç«¯æ‹–æ‹½) */
        #schemaContainer { position: relative; }
        .schema-card { 
            background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; 
            padding: 15px; margin-bottom: 12px; position: relative;
            touch-action: none; /* é‡è¦ï¼šç¦ç”¨ç€è¦½å™¨é è¨­è§¸æ§è¡Œç‚ºä»¥åˆ©æ‹–æ‹½ */
            user-select: none; transition: box-shadow 0.2s, transform 0.2s;
        }
        .schema-card.dragging { 
            opacity: 0.8; background: white; box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
            transform: scale(1.02); z-index: 1000; position: absolute; width: calc(100% - 30px);
        }
        .drag-handle { 
            cursor: move; color: var(--secondary); font-size: 24px; margin-right: 10px;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            background: #edf2f7; border-radius: 6px;
        }
        .schema-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }
        .schema-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }

        /* åœ–æ¨™é¸æ“‡å™¨ */
        .icon-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
        .icon-option { 
            display: flex; align-items: center; justify-content: center; height: 40px; border-radius: 8px; 
            border: 1px solid var(--border); font-size: 1.2em; background: white;
        }
        .icon-option.selected { border-color: var(--primary); background: var(--accent); }

        .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; font-weight: 700; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--secondary); }
        .json-editor { width: 100%; height: 180px; font-family: monospace; background: #1e293b; color: #cbd5e1; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <div class="nav-container">
        <div class="logo">TaskMaster âš¡</div>
        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('list')">åˆ—è¡¨</button>
            <button class="tab-btn" onclick="switchTab('editor')">ç·¨è¼¯</button>
            <button class="tab-btn" onclick="switchTab('config')">é…ç½®</button>
        </nav>
    </div>
</header>

<div class="main-content">
    <div id="list" class="tab-panel active">
        <div class="card">
            <input type="text" id="searchBar" placeholder="æœå°‹..." oninput="renderTaskList()" style="margin-bottom:15px;">
            <div id="filterArea" style="display:flex; gap:8px; margin-bottom:15px; flex-wrap:wrap;"></div>
            <div class="table-wrapper">
                <table><thead id="taskHeader"></thead><tbody id="taskList"></tbody></table>
            </div>
        </div>
    </div>

    <div id="editor" class="tab-panel">
        <div class="card">
            <h3 id="formTitle" style="margin-top:0">ä»»å‹™ç·¨è¼¯</h3>
            <form id="taskForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="form-group"><label>æ’åºæ¬Šé‡</label><input type="number" id="taskWeight" value="0"></div>
                <div id="dynamicFields"></div>
                <button type="submit" class="btn btn-primary" style="width:100%; justify-content:center;">å„²å­˜</button>
            </form>
        </div>
    </div>

    <div id="config" class="tab-panel">
        <div class="card">
            <h3>å±¬æ€§æ’åº (æŒ‰ä½æ‹–å‹•)</h3>
            <div id="schemaContainer"></div>
            <button class="btn btn-outline" onclick="addSchemaField()" style="width:100%; border-style:dashed;">+ æ–°å¢å±¬æ€§</button>
            <button class="btn btn-primary" onclick="applySchema()" style="width:100%; margin-top:15px; justify-content:center;">å„²å­˜é…ç½®è®Šæ›´</button>
        </div>
        <div class="card">
            <h3>å‚™ä»½èˆ‡å¾©åŸ</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn btn-outline" onclick="downloadJSON()">ä¸‹è¼‰å‚™ä»½</button>
                <button class="btn btn-outline" onclick="importJSON()">åŒ¯å…¥å‚™ä»½</button>
            </div>
            <textarea id="fullDataEditor" class="json-editor"></textarea>
            <button class="btn btn-primary" onclick="saveEditorToBrowser()" style="width:100%; margin-top:10px; justify-content:center;">æ›´æ–°åˆ°æœ¬åœ°</button>
        </div>
    </div>
</div>

<script>
    const ICONS = ["ğŸ¯", "âœ…", "ğŸš€", "â³", "âš ï¸", "ğŸ›‘", "â­", "ğŸ”¥", "ğŸ’¡", "ğŸ‘¤", "ğŸ’¼"];
    let appData = {
        schema: [
            { id: "icon", name: "åœ–æ¨™", type: "icon", required: false, options: "" },
            { id: "title", name: "åç¨±", type: "text", required: true, options: "" },
            { id: "status", name: "ç‹€æ…‹", type: "select", required: true, options: "å¾…è¾¦,é€²è¡Œä¸­,å®Œæˆ" }
        ],
        tasks: []
    };

    function init() {
        const saved = localStorage.getItem('TaskApp_V6_Mobile');
        if (saved) appData = JSON.parse(saved);
        renderAll();
    }

    function renderAll() {
        renderSchemaManager(); renderDynamicForm(); renderFilters(); renderTaskList();
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-panel, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
        if(t==='config') document.getElementById('fullDataEditor').value = JSON.stringify(appData, null, 2);
    }

    // --- æ”¹è‰¯ç‰ˆæ‹–æ‹½ (æ”¯æ´æ‰‹æ©Ÿè§¸æ§) ---
    let dragItem = null;
    let dragIdx = null;
    let containerRect = null;

    function renderSchemaManager() {
        const container = document.getElementById('schemaContainer');
        container.innerHTML = '';
        appData.schema.forEach((f, i) => {
            const card = document.createElement('div');
            card.className = 'schema-card';
            card.dataset.index = i;
            card.innerHTML = `
                <div class="schema-header">
                    <div class="drag-handle">â ¿</div>
                    <button class="btn-danger-text" onclick="removeSchemaField(${i})">âœ•</button>
                </div>
                <div class="schema-grid">
                    <div class="form-group"><label>é¡¯ç¤ºåç¨±</label><input type="text" value="${f.name}" onchange="updateSchema(${i},'name',this.value)"></div>
                    <div class="form-group"><label>é¡å‹</label>
                        <select onchange="updateSchema(${i},'type',this.value)">
                            <option value="text" ${f.type==='text'?'selected':''}>æ–‡å­—</option>
                            <option value="date" ${f.type==='date'?'selected':''}>æ—¥æœŸ</option>
                            <option value="number" ${f.type==='number'?'selected':''}>æ•¸å­—</option>
                            <option value="select" ${f.type==='select'?'selected':''}>é¸å–®</option>
                            <option value="icon" ${f.type==='icon'?'selected':''}>åœ–æ¨™</option>
                        </select>
                    </div>
                </div>
                <label style="margin-top:10px;"><input type="checkbox" ${f.required?'checked':''} onchange="updateSchema(${i},'required',this.checked)"> å¿…å¡«</label>
                ${f.type==='select' ? `<input type="text" style="margin-top:10px" placeholder="é¸é …(é€—è™Ÿéš”é–‹)" value="${f.options}" onchange="updateSchema(${i},'options',this.value)">`:''}
            `;

            // è§¸æ§äº‹ä»¶ç¶å®š
            card.querySelector('.drag-handle').addEventListener('touchstart', (e) => startDrag(e, card, i), {passive: false});
            card.querySelector('.drag-handle').addEventListener('mousedown', (e) => startDrag(e, card, i));
            container.appendChild(card);
        });
    }

    function startDrag(e, card, index) {
        dragItem = card;
        dragIdx = index;
        containerRect = document.getElementById('schemaContainer').getBoundingClientRect();
        
        const moveHandler = (evt) => onDragging(evt);
        const endHandler = () => {
            dragItem.classList.remove('dragging');
            dragItem.style.top = '';
            window.removeEventListener('mousemove', moveHandler);
            window.removeEventListener('mouseup', endHandler);
            window.removeEventListener('touchmove', moveHandler);
            window.removeEventListener('touchend', endHandler);
            reorderSchema();
        };

        dragItem.classList.add('dragging');
        window.addEventListener('mousemove', moveHandler);
        window.addEventListener('mouseup', endHandler);
        window.addEventListener('touchmove', moveHandler, {passive: false});
        window.addEventListener('touchend', endHandler);
    }

    function onDragging(e) {
        e.preventDefault();
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const container = document.getElementById('schemaContainer');
        const cards = [...container.querySelectorAll('.schema-card:not(.dragging)')];
        
        // æ‰¾åˆ°æœ€æ¥è¿‘çš„ä¸‹ä¸€å€‹å…ƒç´ 
        const afterElement = cards.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = clientY - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;

        if (afterElement == null) container.appendChild(dragItem);
        else container.insertBefore(dragItem, afterElement);
    }

    function reorderSchema() {
        const newSchema = [];
        document.querySelectorAll('.schema-card').forEach(card => {
            newSchema.push(appData.schema[card.dataset.index]);
        });
        appData.schema = newSchema;
        renderSchemaManager(); // é‡ç¹ªä»¥æ›´æ–° dataset index
    }

    // --- åŸºæœ¬é‚è¼¯ ---
    function addSchemaField() { appData.schema.push({ id: "f"+Date.now(), name: "æ–°å±¬æ€§", type: "text", required: false, options: "" }); renderSchemaManager(); }
    function removeSchemaField(i) { appData.schema.splice(i,1); renderSchemaManager(); }
    function updateSchema(i, k, v) { appData.schema[i][k] = v; if(k==='type') renderSchemaManager(); }
    function applySchema() { localStorage.setItem('TaskApp_V6_Mobile', JSON.stringify(appData)); renderAll(); alert("é…ç½®å·²å„²å­˜"); }

    function renderDynamicForm() {
        const container = document.getElementById('dynamicFields');
        container.innerHTML = appData.schema.map(f => {
            let input = '';
            if (f.type === 'icon') {
                input = `<input type="hidden" id="field_${f.id}" value=""><div class="icon-selector" id="wrap_${f.id}">${ICONS.map(i => `<div class="icon-option" onclick="pickIcon('${f.id}','${i}')">${i}</div>`).join('')}</div>`;
            } else if (f.type === 'select') {
                input = `<select id="field_${f.id}" ${f.required?'required':''}><option value="">è«‹é¸æ“‡</option>${f.options.split(/[,ï¼Œ]/).map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}</select>`;
            } else {
                input = `<input type="${f.type}" id="field_${f.id}" ${f.required?'required':''} placeholder="${f.name}">`;
            }
            return `<div class="form-group"><label>${f.name}${f.required?'*':''}</label>${input}</div>`;
        }).join('');
    }

    function pickIcon(fid, icon) {
        document.getElementById('field_'+fid).value = icon;
        document.querySelectorAll(`#wrap_${fid} .icon-option`).forEach(opt => opt.classList.toggle('selected', opt.innerText === icon));
    }

    function renderTaskList() {
        const q = document.getElementById('searchBar').value.toLowerCase();
        document.getElementById('taskHeader').innerHTML = `<tr><th>#</th>${appData.schema.map(f => `<th>${f.name}</th>`).join('')}</tr>`;
        let filtered = appData.tasks.filter(t => Object.values(t).some(v => String(v).toLowerCase().includes(q)))
                        .sort((a,b) => (a._w||0) - (b._w||0));
        document.getElementById('taskList').innerHTML = filtered.map(t => {
            const idx = appData.tasks.indexOf(t);
            return `<tr onclick="editTask(${idx})"><td>${t._w||0}</td>${appData.schema.map(f => `<td>${t[f.id]||''}</td>`).join('')}</tr>`;
        }).join('');
    }

    function renderFilters() {
        document.getElementById('filterArea').innerHTML = appData.schema.filter(f => f.type==='select').map(f => `
            <select onchange="filterList('${f.id}', this.value)" style="width:auto"><option value="">æ‰€æœ‰${f.name}</option>${f.options.split(/[,ï¼Œ]/).map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}</select>
        `).join('');
    }

    document.getElementById('taskForm').onsubmit = (e) => {
        e.preventDefault();
        const idx = parseInt(document.getElementById('editIndex').value);
        const task = { _w: parseInt(document.getElementById('taskWeight').value) };
        appData.schema.forEach(f => task[f.id] = document.getElementById(`field_${f.id}`).value);
        if (idx === -1) appData.tasks.push(task); else appData.tasks[idx] = task;
        localStorage.setItem('TaskApp_V6_Mobile', JSON.stringify(appData));
        resetAndReturn();
    };

    function editTask(i) {
        const t = appData.tasks[i];
        document.getElementById('editIndex').value = i;
        document.getElementById('taskWeight').value = t._w || 0;
        appData.schema.forEach(f => {
            const el = document.getElementById(`field_${f.id}`);
            if(el) { el.value = t[f.id] || ''; if(f.type==='icon') pickIcon(f.id, t[f.id]); }
        });
        switchTab('editor');
    }

    function resetAndReturn() { document.getElementById('taskForm').reset(); document.getElementById('editIndex').value="-1"; renderTaskList(); switchTab('list'); }

    function downloadJSON() {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([JSON.stringify(appData, null, 2)], { type: "application/json" }));
        a.download = "taskApp.json"; a.click();
    }

    function importJSON() {
        const i = document.createElement('input'); i.type = 'file';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => { appData = JSON.parse(ev.target.result); localStorage.setItem('TaskApp_V6_Mobile', JSON.stringify(appData)); location.reload(); };
            r.readAsText(e.target.files[0]);
        };
        i.click();
    }

    function saveEditorToBrowser() { appData = JSON.parse(document.getElementById('fullDataEditor').value); localStorage.setItem('TaskApp_V6_Mobile', JSON.stringify(appData)); location.reload(); }

    init();
</script>
</body>
</html>
