<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro - è¦–è¦ºåŒ–åœ–æ¨™ç‰ˆ</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #64748b;
            --bg: #f3f4f6; --card-bg: #ffffff; --text: #1e293b; --border: #e2e8f0; --accent: #eff6ff;
            --danger: #ef4444;
        }
        body { font-family: 'Inter', "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        /* Header & Nav */
        header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 0 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .nav-container { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 70px; }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); }
        .tabs { display: flex; gap: 8px; }
        .tab-btn { padding: 10px 18px; cursor: pointer; border: none; background: transparent; font-weight: 600; color: var(--secondary); border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { background: var(--accent); color: var(--primary); }

        /* Layout */
        .main-content { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 25px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼å„ªåŒ– */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead th { background: #f8fafc; padding: 15px; text-align: left; position: sticky; top: 0; z-index: 5; border-bottom: 2px solid var(--border); font-size: 14px; }
        tbody tr:hover { background: var(--accent); cursor: pointer; }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .icon-cell { font-size: 1.2em; }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #475569; }
        .required-mark { color: var(--danger); margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 15px; }

        /* å±¬æ€§é…ç½®å¡ç‰‡ (å„ªåŒ–é¡¯ç¤ºæ•ˆæœ) */
        .schema-card { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 18px; margin-bottom: 15px; position: relative; }
        .schema-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .schema-actions { position: absolute; top: 15px; right: 15px; }

        /* åœ–æ¨™é¸æ“‡å™¨å°ˆç”¨ */
        .icon-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: white; }
        .icon-option { 
            display: flex; align-items: center; justify-content: center; height: 40px; border-radius: 6px; 
            cursor: pointer; border: 1px solid transparent; font-size: 1.2em; transition: 0.2s;
        }
        .icon-option:hover { background: var(--accent); }
        .icon-option.selected { border-color: var(--primary); background: var(--accent); box-shadow: 0 0 0 2px var(--accent); }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn { padding: 12px 24px; border-radius: 8px; cursor: pointer; border: none; font-weight: 700; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--secondary); }
        .btn-danger-text { color: var(--danger); padding: 5px; font-size: 18px; line-height: 1; background:none; border:none; cursor:pointer;}

        .json-editor { width: 100%; height: 250px; font-family: monospace; font-size: 13px; padding: 15px; background: #0f172a; color: #cbd5e1; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <div class="nav-container">
        <div class="logo">TaskMaster <span style="font-weight: 300; font-size: 0.7em; opacity: 0.7;">v5.0</span></div>
        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('list')">ä»»å‹™åˆ—è¡¨</button>
            <button class="tab-btn" id="editor-trigger" onclick="switchTab('editor')">æ–°å¢/ç·¨è¼¯</button>
            <button class="tab-btn" onclick="switchTab('config')">é…ç½®/å‚™ä»½</button>
        </nav>
    </div>
</header>

<div class="main-content">
    <!-- 1. ä»»å‹™åˆ—è¡¨ -->
    <div id="list" class="tab-panel active">
        <div class="card">
            <div style="display:flex; gap:12px; margin-bottom:20px; align-items:center;">
                <input type="text" id="searchBar" style="flex:1" placeholder="æœå°‹ä»»å‹™å…§å®¹..." oninput="renderTaskList()">
                <div id="filterArea" style="display:flex; gap:10px;"></div>
            </div>
            <div class="table-wrapper">
                <table><thead id="taskHeader"></thead><tbody id="taskList"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 2. æ–°å¢/ç·¨è¼¯ -->
    <div id="editor" class="tab-panel">
        <div class="card" style="max-width:650px; margin:0 auto;">
            <h2 id="formTitle" style="margin-top:0">æ–°å¢ä»»å‹™</h2>
            <form id="taskForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="form-group">
                    <label>æ’åºæ¬Šé‡</label>
                    <input type="number" id="taskWeight" value="0">
                </div>
                <div id="dynamicFields"></div>
                <div class="btn-group" style="display:flex; gap:12px; margin-top:30px;">
                    <button type="submit" class="btn btn-primary" style="flex:1">å„²å­˜ä»»å‹™</button>
                    <button type="button" class="btn btn-outline" onclick="resetAndReturn()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. é…ç½®/å‚™ä»½ -->
    <div id="config" class="tab-panel">
        <div class="card">
            <h3>å±¬æ€§çµæ§‹å®šç¾© (Schema)</h3>
            <div id="schemaList"></div>
            <button class="btn btn-outline" onclick="addSchemaField()" style="width:100%; border-style:dashed; margin-top:10px;">+ æ–°å¢å±¬æ€§æ¬„ä½</button>
            <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                <button class="btn btn-primary" onclick="applySchema()">å„²å­˜é…ç½®ä¸¦åˆ·æ–°</button>
            </div>
        </div>

        <div class="card">
            <h3>æ•¸æ“šå‚™ä»½</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-outline" onclick="downloadJSON()">ä¸‹è¼‰ JSON</button>
                <button class="btn btn-outline" onclick="saveToLocalSystem()">ä¿å­˜åˆ°æœ¬åœ°</button>
                <button class="btn btn-outline" onclick="importJSON()">åŒ¯å…¥æ•¸æ“š</button>
            </div>
            <textarea id="fullDataEditor" class="json-editor"></textarea>
            <button class="btn btn-primary" onclick="saveEditorToBrowser()" style="margin-top:10px;">æ›´æ–° LocalStorage</button>
        </div>
    </div>
</div>

<script>
    // é è¨­åœ–æ¨™åº«
    const ICON_LIBRARY = ["ğŸ¯", "ğŸ”¥", "âœ…", "â³", "âš ï¸", "ğŸš€", "ğŸ’¡", "ğŸ›‘", "â­", "ğŸ“…", "ğŸ‘¤", "ğŸ’¼", "ğŸ› ï¸", "ğŸ””"];

    let appData = {
        schema: [
            { id: "icon", name: "åœ–æ¨™", type: "icon", required: false },
            { id: "title", name: "ä»»å‹™åç¨±", type: "text", required: true },
            { id: "status", name: "ç‹€æ…‹", type: "select", options: "å¾…è¾¦, é€²è¡Œä¸­, å·²å®Œæˆ", required: true }
        ],
        tasks: []
    };

    function init() {
        const saved = localStorage.getItem('taskApp_V5');
        if (saved) appData = JSON.parse(saved);
        renderSchemaManager(); renderDynamicForm(); renderFilters(); renderTaskList();
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-panel, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
        if(t === 'config') document.getElementById('fullDataEditor').value = JSON.stringify(appData, null, 2);
    }

    // --- Schema ç®¡ç† ---
    function renderSchemaManager() {
        const container = document.getElementById('schemaList');
        container.innerHTML = appData.schema.map((f, i) => `
            <div class="schema-card">
                <div class="schema-actions"><button class="btn-danger-text" onclick="removeSchemaField(${i})">âœ•</button></div>
                <div class="schema-grid">
                    <div class="form-group" style="margin:0"><label>å±¬æ€§ ID</label><input type="text" value="${f.id}" onchange="updateSchemaItem(${i},'id',this.value)"></div>
                    <div class="form-group" style="margin:0"><label>é¡¯ç¤ºåç¨±</label><input type="text" value="${f.name}" onchange="updateSchemaItem(${i},'name',this.value)"></div>
                    <div class="form-group" style="margin:0"><label>é¡å‹</label>
                        <select onchange="updateSchemaItem(${i},'type',this.value)">
                            <option value="text" ${f.type==='text'?'selected':''}>ç´”æ–‡å­—</option>
                            <option value="date" ${f.type==='date'?'selected':''}>æ—¥æœŸ</option>
                            <option value="number" ${f.type==='number'?'selected':''}>æ•¸å­—</option>
                            <option value="select" ${f.type==='select'?'selected':''}>é¸å–®</option>
                            <option value="icon" ${f.type==='icon'?'selected':''}>åœ–æ¨™</option>
                        </select>
                    </div>
                    <div style="padding-bottom:10px;"><label><input type="checkbox" ${f.required?'checked':''} onchange="updateSchemaItem(${i},'required',this.checked)"> å¿…å¡«</label></div>
                </div>
                ${f.type==='select' ? `<div style="margin-top:10px;"><label>é¸é … (é€—è™Ÿéš”é–‹)</label><input type="text" value="${f.options||''}" onchange="updateSchemaItem(${i},'options',this.value)"></div>` : ''}
            </div>
        `).join('');
    }

    function addSchemaField() {
        appData.schema.push({ id: "attr_"+Date.now(), name: "æ–°å±¬æ€§", type: "text", required: false });
        renderSchemaManager();
    }

    function removeSchemaField(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { appData.schema.splice(i,1); renderSchemaManager(); } }

    function updateSchemaItem(i, k, v) { appData.schema[i][k] = v; if(k==='type') renderSchemaManager(); }

    function applySchema() {
        localStorage.setItem('taskApp_V5', JSON.stringify(appData));
        renderDynamicForm(); renderFilters(); renderTaskList();
        alert("é…ç½®å·²å¥—ç”¨ï¼");
    }

    // --- ä»»å‹™è¡¨å–®æ¸²æŸ“ ---
    function renderDynamicForm() {
        const container = document.getElementById('dynamicFields');
        container.innerHTML = appData.schema.map(f => {
            let input = '';
            if (f.type === 'icon') {
                input = `
                <input type="hidden" id="field_${f.id}" value="">
                <div class="icon-selector" id="wrapper_${f.id}">
                    ${ICON_LIBRARY.map(icon => `<div class="icon-option" onclick="selectIcon('${f.id}', '${icon}')">${icon}</div>`).join('')}
                </div>`;
            } else if (f.type === 'select') {
                input = `<select id="field_${f.id}" ${f.required?'required':''}>
                    <option value="">é¸æ“‡${f.name}</option>
                    ${(f.options||"").split(/[,ï¼Œ]/).map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}
                </select>`;
            } else {
                input = `<input type="${f.type}" id="field_${f.id}" ${f.required?'required':''} placeholder="è«‹è¼¸å…¥${f.name}">`;
            }
            return `<div class="form-group"><label>${f.name}${f.required?'<span class="required-mark">*</span>':''}</label>${input}</div>`;
        }).join('');
    }

    function selectIcon(fieldId, icon) {
        document.getElementById(`field_${fieldId}`).value = icon;
        const options = document.querySelectorAll(`#wrapper_${fieldId} .icon-option`);
        options.forEach(opt => opt.classList.toggle('selected', opt.innerText === icon));
    }

    // --- åˆ—è¡¨èˆ‡éæ¿¾ ---
    function renderTaskList() {
        const q = document.getElementById('searchBar').value.toLowerCase();
        document.getElementById('taskHeader').innerHTML = `<tr><th>æ¬Šé‡</th>${appData.schema.map(f => `<th>${f.name}</th>`).join('')}<th>æ“ä½œ</th></tr>`;
        
        let filtered = appData.tasks.filter(t => {
            const mS = Object.values(t).some(v => String(v).toLowerCase().includes(q));
            const mF = appData.schema.filter(f => f.type==='select').every(f => {
                const val = document.getElementById(`filter_${f.id}`)?.value;
                return !val || t[f.id] === val;
            });
            return mS && mF;
        }).sort((a,b) => (a._w||0) - (b._w||0));

        document.getElementById('taskList').innerHTML = filtered.map(t => {
            const idx = appData.tasks.indexOf(t);
            return `<tr onclick="editTask(${idx})"><td>${t._w||0}</td>
                ${appData.schema.map(f => `<td class="${f.type==='icon'?'icon-cell':''}">${t[f.id]||''}</td>`).join('')}
                <td><button class="btn-danger-text" onclick="event.stopPropagation(); deleteTask(${idx})">åˆªé™¤</button></td></tr>`;
        }).join('');
    }

    function renderFilters() {
        document.getElementById('filterArea').innerHTML = appData.schema.filter(f => f.type === 'select').map(f => `
            <select id="filter_${f.id}" onchange="renderTaskList()" style="width:auto">
                <option value="">æ‰€æœ‰${f.name}</option>
                ${(f.options||"").split(/[,ï¼Œ]/).map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}
            </select>
        `).join('');
    }

    // --- CRUD ---
    document.getElementById('taskForm').onsubmit = (e) => {
        e.preventDefault();
        const idx = parseInt(document.getElementById('editIndex').value);
        const task = { _w: parseInt(document.getElementById('taskWeight').value) };
        appData.schema.forEach(f => task[f.id] = document.getElementById(`field_${f.id}`).value);
        
        if (idx === -1) appData.tasks.push(task); else appData.tasks[idx] = task;
        localStorage.setItem('taskApp_V5', JSON.stringify(appData));
        resetAndReturn();
    };

    function editTask(i) {
        const t = appData.tasks[i];
        document.getElementById('editIndex').value = i;
        document.getElementById('formTitle').innerText = "ç·¨è¼¯ä»»å‹™";
        document.getElementById('taskWeight').value = t._w || 0;
        appData.schema.forEach(f => {
            const val = t[f.id] || '';
            const el = document.getElementById(`field_${f.id}`);
            if(el) el.value = val;
            if(f.type === 'icon' && val) selectIcon(f.id, val);
        });
        switchTab('editor');
    }

    function deleteTask(i) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { appData.tasks.splice(i,1); localStorage.setItem('taskApp_V5', JSON.stringify(appData)); renderTaskList(); } }
    function resetAndReturn() { document.getElementById('taskForm').reset(); document.getElementById('editIndex').value="-1"; renderTaskList(); switchTab('list'); }

    // --- IO ---
    function downloadJSON() {
        const blob = new Blob([JSON.stringify(appData, null, 2)], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "taskApp.json"; a.click();
    }
    async function saveToLocalSystem() {
        try {
            const h = await window.showSaveFilePicker({ suggestedName: 'taskApp.json' });
            const w = await h.createWritable(); await w.write(JSON.stringify(appData, null, 2)); await w.close();
        } catch(e) {}
    }
    function importJSON() {
        const i = document.createElement('input'); i.type = 'file';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => { appData = JSON.parse(ev.target.result); localStorage.setItem('taskApp_V5', JSON.stringify(appData)); location.reload(); };
            r.readAsText(e.target.files[0]);
        };
        i.click();
    }
    function saveEditorToBrowser() { try { appData = JSON.parse(document.getElementById('fullDataEditor').value); localStorage.setItem('taskApp_V5', JSON.stringify(appData)); location.reload(); } catch(e){alert('æ ¼å¼éŒ¯èª¤');} }

    init();
</script>
</body>
</html>
