<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro - ä¼æ¥­ç´šå…¨è‡ªå®šç¾©ä»»å‹™ç³»çµ±</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #64748b;
            --bg: #f3f4f6; --card-bg: #ffffff; --text: #1e293b; --border: #e2e8f0; --accent: #eff6ff;
            --danger: #ef4444; --success: #22c55e;
        }
        body { font-family: 'Inter', "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        /* Header & Nav */
        header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 0 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 70px; }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .tabs { display: flex; gap: 8px; }
        .tab-btn { padding: 10px 18px; cursor: pointer; border: none; background: transparent; font-weight: 600; color: var(--secondary); border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { background: var(--accent); color: var(--primary); }

        /* Layout */
        .main-content { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 25px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼å„ªåŒ– */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead th { background: #f8fafc; padding: 15px; text-align: left; position: sticky; top: 0; z-index: 5; border-bottom: 2px solid var(--border); font-size: 14px; }
        tbody tr:hover { background: var(--accent); cursor: pointer; }
        td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 14px; }

        /* è¡¨å–®èˆ‡æ¬„ä½ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #475569; }
        .required-mark { color: var(--danger); margin-left: 4px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        
        /* å±¬æ€§é…ç½®å¡ç‰‡ (æ”¯æ´æ‹–æ‹½) */
        .schema-card { 
            background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; 
            padding: 18px; margin-bottom: 15px; position: relative; cursor: default;
            transition: all 0.2s;
        }
        .schema-card.dragging { opacity: 0.5; border: 2px dashed var(--primary); transform: scale(0.98); }
        .drag-handle { 
            cursor: grab; color: var(--secondary); font-size: 20px; position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
            display: flex; align-items: center; justify-content: center; width: 30px;
        }
        .schema-grid { margin-left: 35px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }

        /* åœ–æ¨™é¸æ“‡å™¨ */
        .icon-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 8px; margin-top: 5px; }
        .icon-option { 
            display: flex; align-items: center; justify-content: center; height: 42px; border-radius: 8px; 
            cursor: pointer; border: 1px solid var(--border); font-size: 1.2em; background: white;
        }
        .icon-option.selected { border-color: var(--primary); background: var(--accent); box-shadow: 0 0 0 2px var(--primary); }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn { padding: 12px 24px; border-radius: 8px; cursor: pointer; border: none; font-weight: 700; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--secondary); }
        .btn-danger-text { color: var(--danger); border: none; background: none; cursor: pointer; font-size: 18px; }
        
        .json-editor { width: 100%; height: 200px; font-family: 'Fira Code', monospace; font-size: 12px; padding: 12px; background: #1e293b; color: #cbd5e1; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <div class="nav-container">
        <div class="logo">TaskMaster <span>âš¡</span></div>
        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('list')">ä»»å‹™åˆ—è¡¨</button>
            <button class="tab-btn" id="editor-trigger" onclick="switchTab('editor')">æ–°å¢/ç·¨è¼¯</button>
            <button class="tab-btn" onclick="switchTab('config')">é…ç½®/å‚™ä»½</button>
        </nav>
    </div>
</header>

<div class="main-content">
    <!-- 1. ä»»å‹™åˆ—è¡¨ -->
    <div id="list" class="tab-panel active">
        <div class="card">
            <div style="display:flex; gap:12px; margin-bottom:20px;">
                <input type="text" id="searchBar" placeholder="æœå°‹ä»»æ„å…§å®¹..." oninput="renderTaskList()">
                <div id="filterArea" style="display:flex; gap:10px;"></div>
            </div>
            <div class="table-wrapper">
                <table><thead id="taskHeader"></thead><tbody id="taskList"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 2. æ–°å¢/ç·¨è¼¯ -->
    <div id="editor" class="tab-panel">
        <div class="card" style="max-width:650px; margin:0 auto;">
            <h2 id="formTitle" style="margin-top:0">æ–°å¢ä»»å‹™</h2>
            <form id="taskForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="form-group"><label>æ’åºæ¬Šé‡ (è¶Šå°è¶Šé å‰)</label><input type="number" id="taskWeight" value="0"></div>
                <div id="dynamicFields"></div>
                <div style="display:flex; gap:12px; margin-top:30px;">
                    <button type="submit" class="btn btn-primary" style="flex:1">å„²å­˜æ•¸æ“š</button>
                    <button type="button" class="btn btn-outline" onclick="resetAndReturn()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. é…ç½®/å‚™ä»½ -->
    <div id="config" class="tab-panel">
        <div class="card">
            <h3>å±¬æ€§é…ç½®èˆ‡æ‹–æ‹½æ’åº</h3>
            <p style="color:var(--secondary); font-size:13px; margin-bottom:15px;">ğŸ’¡ æ‚¨å¯ä»¥æ‹–æ‹½ â ¿ åœ–æ¨™ä¾†èª¿æ•´å±¬æ€§åœ¨è¡¨å–®èˆ‡åˆ—è¡¨ä¸­çš„é †åºã€‚</p>
            <div id="schemaContainer"></div>
            <button class="btn btn-outline" onclick="addSchemaField()" style="width:100%; border-style:dashed; margin-top:10px;">+ æ–°å¢å±¬æ€§æ¬„ä½</button>
            <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                <button class="btn btn-primary" onclick="applySchema()">å¥—ç”¨é…ç½®è®Šæ›´</button>
            </div>
        </div>

        <div class="card">
            <h3>æ•¸æ“šå°å‡ºèˆ‡å‚™ä»½</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-outline" onclick="downloadJSON()">ä¸‹è¼‰å‚™ä»½</button>
                <button class="btn btn-outline" onclick="saveToLocalSystem()">æœ¬åœ°å­˜æª” (Picker)</button>
                <button class="btn btn-outline" onclick="importJSON()">åŒ¯å…¥å‚™ä»½</button>
            </div>
            <label>åŸå§‹æ•¸æ“š (JSON)</label>
            <textarea id="fullDataEditor" class="json-editor"></textarea>
            <button class="btn btn-primary" onclick="saveEditorToBrowser()" style="margin-top:10px;">æ›´æ–° LocalStorage</button>
        </div>
    </div>
</div>

<script>
    const ICONS = ["ğŸ¯", "âœ…", "â³", "ğŸš€", "âš ï¸", "ğŸ›‘", "â­", "ğŸ’¡", "ğŸ‘¤", "ğŸ“…", "ğŸ”¥", "ğŸ””"];
    
    let appData = {
        schema: [
            { id: "icon", name: "åœ–æ¨™", type: "icon", required: false, options: "" },
            { id: "title", name: "ä»»å‹™åç¨±", type: "text", required: true, options: "" },
            { id: "status", name: "ç‹€æ…‹", type: "select", required: true, options: "å¾…è¾¦, åŸ·è¡Œä¸­, å·²å®Œæˆ" }
        ],
        tasks: []
    };

    function init() {
        const saved = localStorage.getItem('TaskApp_Final_V1');
        if (saved) appData = JSON.parse(saved);
        renderAll();
    }

    function renderAll() {
        renderSchemaManager(); renderDynamicForm(); renderFilters(); renderTaskList();
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-panel, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
        if(t === 'config') document.getElementById('fullDataEditor').value = JSON.stringify(appData, null, 2);
    }

    // --- Schema & Drag Drop é‚è¼¯ ---
    function renderSchemaManager() {
        const container = document.getElementById('schemaContainer');
        container.innerHTML = '';
        appData.schema.forEach((f, i) => {
            const card = document.createElement('div');
            card.className = 'schema-card';
            card.draggable = true;
            card.dataset.index = i;
            
            card.innerHTML = `
                <div class="drag-handle">â ¿</div>
                <div class="schema-actions" style="position:absolute; right:15px; top:15px;">
                    <button class="btn-danger-text" onclick="removeSchemaField(${i})">âœ•</button>
                </div>
                <div class="schema-grid">
                    <div class="form-group" style="margin:0"><label>ID</label><input type="text" value="${f.id}" onchange="updateSchema(${i},'id',this.value)"></div>
                    <div class="form-group" style="margin:0"><label>é¡¯ç¤ºåç¨±</label><input type="text" value="${f.name}" onchange="updateSchema(${i},'name',this.value)"></div>
                    <div class="form-group" style="margin:0"><label>é¡å‹</label>
                        <select onchange="updateSchema(${i},'type',this.value)">
                            <option value="text" ${f.type==='text'?'selected':''}>ç´”æ–‡å­—</option>
                            <option value="date" ${f.type==='date'?'selected':''}>æ—¥æœŸ</option>
                            <option value="number" ${f.type==='number'?'selected':''}>æ•¸å­—</option>
                            <option value="select" ${f.type==='select'?'selected':''}>é¸å–®</option>
                            <option value="icon" ${f.type==='icon'?'selected':''}>åœ–æ¨™</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;"><label><input type="checkbox" ${f.required?'checked':''} onchange="updateSchema(${i},'required',this.checked)"> å¿…å¡«</label></div>
                </div>
                ${f.type === 'select' ? `<div style="margin: 15px 0 0 35px;"><label>é¸å–®é¸é … (é€—è™Ÿéš”é–‹)</label><input type="text" value="${f.options}" onchange="updateSchema(${i},'options',this.value)"></div>` : ''}
            `;
            
            // ç¶å®šæ‹–æ‹½äº‹ä»¶
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            container.appendChild(card);
        });
    }

    let dragSourceIndex = null;
    function handleDragStart(e) { dragSourceIndex = this.dataset.index; this.classList.add('dragging'); }
    function handleDragOver(e) { e.preventDefault(); }
    function handleDrop(e) {
        const targetIndex = this.dataset.index;
        if (dragSourceIndex !== targetIndex) {
            const movedItem = appData.schema.splice(dragSourceIndex, 1)[0];
            appData.schema.splice(targetIndex, 0, movedItem);
            renderSchemaManager();
        }
    }
    function handleDragEnd() { this.classList.remove('dragging'); }

    function addSchemaField() {
        appData.schema.push({ id: "field_"+Date.now(), name: "æ–°å±¬æ€§", type: "text", required: false, options: "" });
        renderSchemaManager();
    }
    function removeSchemaField(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { appData.schema.splice(i,1); renderSchemaManager(); } }
    function updateSchema(i, k, v) { appData.schema[i][k] = v; if(k==='type') renderSchemaManager(); }
    function applySchema() { localStorage.setItem('TaskApp_Final_V1', JSON.stringify(appData)); renderAll(); alert("é…ç½®å·²æ›´æ–°ï¼"); }

    // --- ä»»å‹™è¡¨å–®èˆ‡åˆ—è¡¨ ---
    function renderDynamicForm() {
        const container = document.getElementById('dynamicFields');
        container.innerHTML = appData.schema.map(f => {
            let input = '';
            if (f.type === 'icon') {
                input = `<input type="hidden" id="field_${f.id}" ${f.required?'required':''} value="">
                         <div class="icon-selector" id="wrap_${f.id}">${ICONS.map(icon => `<div class="icon-option" onclick="pickIcon('${f.id}','${icon}')">${icon}</div>`).join('')}</div>`;
            } else if (f.type === 'select') {
                input = `<select id="field_${f.id}" ${f.required?'required':''}><option value="">è«‹é¸æ“‡</option>${f.options.split(/[,ï¼Œ]/).map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}</select>`;
            } else {
                input = `<input type="${f.type}" id="field_${f.id}" ${f.required?'required':''} placeholder="è«‹è¼¸å…¥${f.name}">`;
            }
            return `<div class="form-group"><label>${f.name}${f.required?'<span class="required-mark">*</span>':''}</label>${input}</div>`;
        }).join('');
    }

    function pickIcon(fid, icon) {
        document.getElementById('field_'+fid).value = icon;
        document.querySelectorAll(`#wrap_${fid} .icon-option`).forEach(opt => opt.classList.toggle('selected', opt.innerText === icon));
    }

    function renderTaskList() {
        const q = document.getElementById('searchBar').value.toLowerCase();
        document.getElementById('taskHeader').innerHTML = `<tr><th>æ¬Šé‡</th>${appData.schema.map(f => `<th>${f.name}</th>`).join('')}<th>æ“ä½œ</th></tr>`;
        
        let filtered = appData.tasks.filter(t => {
            const mS = Object.values(t).some(v => String(v).toLowerCase().includes(q));
            const mF = appData.schema.filter(f => f.type==='select').every(f => {
                const val = document.getElementById(`filter_${f.id}`)?.value;
                return !val || t[f.id] === val;
            });
            return mS && mF;
        }).sort((a,b) => (a._w||0) - (b._w||0));

        document.getElementById('taskList').innerHTML = filtered.map(t => {
            const idx = appData.tasks.indexOf(t);
            return `<tr onclick="editTask(${idx})"><td>${t._w||0}</td>
                ${appData.schema.map(f => `<td>${t[f.id]||''}</td>`).join('')}
                <td><button class="btn-danger-text" onclick="event.stopPropagation(); deleteTask(${idx})">âœ•</button></td></tr>`;
        }).join('');
    }

    function renderFilters() {
        document.getElementById('filterArea').innerHTML = appData.schema.filter(f => f.type==='select').map(f => `
            <select id="filter_${f.id}" onchange="renderTaskList()" style="width:auto; padding:8px;">
                <option value="">æ‰€æœ‰${f.name}</option>${f.options.split(/[,ï¼Œ]/).map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('')}
            </select>`).join('');
    }

    // --- CRUD ---
    document.getElementById('taskForm').onsubmit = (e) => {
        e.preventDefault();
        const idx = parseInt(document.getElementById('editIndex').value);
        const task = { _w: parseInt(document.getElementById('taskWeight').value) };
        appData.schema.forEach(f => task[f.id] = document.getElementById(`field_${f.id}`).value);
        if (idx === -1) appData.tasks.push(task); else appData.tasks[idx] = task;
        localStorage.setItem('TaskApp_Final_V1', JSON.stringify(appData));
        resetAndReturn();
    };

    function editTask(i) {
        const t = appData.tasks[i];
        document.getElementById('editIndex').value = i;
        document.getElementById('formTitle').innerText = "ç·¨è¼¯ä»»å‹™";
        document.getElementById('taskWeight').value = t._w || 0;
        appData.schema.forEach(f => {
            const val = t[f.id] || '';
            if (document.getElementById(`field_${f.id}`)) {
                document.getElementById(`field_${f.id}`).value = val;
                if(f.type === 'icon' && val) pickIcon(f.id, val);
            }
        });
        switchTab('editor');
    }

    function deleteTask(i) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { appData.tasks.splice(i,1); localStorage.setItem('TaskApp_Final_V1', JSON.stringify(appData)); renderTaskList(); } }
    function resetAndReturn() { document.getElementById('taskForm').reset(); document.getElementById('editIndex').value="-1"; renderTaskList(); switchTab('list'); }

    // --- æ•¸æ“š IO ---
    function downloadJSON() {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([JSON.stringify(appData, null, 2)], { type: "application/json" }));
        a.download = "taskApp.json"; a.click();
    }
    async function saveToLocalSystem() {
        try {
            const h = await window.showSaveFilePicker({ suggestedName: 'taskApp.json' });
            const w = await h.createWritable(); await w.write(JSON.stringify(appData, null, 2)); await w.close();
        } catch(e) {}
    }
    function importJSON() {
        const i = document.createElement('input'); i.type = 'file';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => { appData = JSON.parse(ev.target.result); localStorage.setItem('TaskApp_Final_V1', JSON.stringify(appData)); location.reload(); };
            r.readAsText(e.target.files[0]);
        };
        i.click();
    }
    function saveEditorToBrowser() { try { appData = JSON.parse(document.getElementById('fullDataEditor').value); localStorage.setItem('TaskApp_Final_V1', JSON.stringify(appData)); location.reload(); } catch(e){alert('JSON æ ¼å¼éŒ¯èª¤');} }

    init();
</script>
</body>
</html>
