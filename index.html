<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­ç´šå…¨ç«¯è‡ªå®šç¾©ä»»å‹™ç®¡ç†ç³»çµ± - å„ªåŒ–ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
            --text-color: #1e293b;
            --row-height: 32px;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-color); overflow-x: hidden; }

        /* å°èˆªèˆ‡å®¹å™¨ */
        nav { display: flex; background: #fff; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; overflow-x: auto; }
        .nav-btn { padding: 12px 20px; border: none; background: none; cursor: pointer; white-space: nowrap; font-size: 15px; color: #64748b; border-bottom: 2px solid transparent; }
        .nav-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        .container { padding: 15px; max-width: 1200px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* è¡¨æ ¼æ¨£å¼ */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .search-box { width: 160px; padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; }
        .table-container { overflow: auto; max-height: calc(100vh - 140px); background: white; border: 1px solid var(--border-color); border-radius: 4px; }
        table { border-collapse: collapse; table-layout: fixed; width: max-content; min-width: 100%; }
        thead th { position: sticky; top: 0; background: #f1f5f9; z-index: 10; border-bottom: 2px solid var(--border-color); border-right: 1px solid var(--border-color); font-size: 13px; padding: 0 8px; height: var(--row-height); line-height: var(--row-height); text-align: left; }
        tbody td { border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); padding: 0 8px; height: var(--row-height); line-height: var(--row-height); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        tbody tr:hover { background: #f8fafc; }
        .btn-del { border: none; background: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 0 5px; }

        /* è¡¨å–®èˆ‡æ§åˆ¶é … */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-control { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        .btn-primary { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

        /* å»ºæ¨¡é …ç›® (Schema) ä½ˆå±€å„ªåŒ– */
        .schema-item { background: white; border: 1px solid var(--border-color); padding: 12px; margin-bottom: 12px; border-radius: 8px; cursor: move; touch-action: none; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .schema-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px; align-items: center; }
        .input-id { flex: 0 0 70px; }
        .input-name { flex: 2; min-width: 140px; }
        .input-type { flex: 1; min-width: 100px; }
        .input-width { flex: 0 0 75px; }
        .check-required { display: flex; align-items: center; font-size: 12px; white-space: nowrap; gap: 4px; }
        
        /* Options åªåœ¨ Select æ™‚é¡¯ç¤ºï¼Œä¸¦ä½”æ»¿ä¸€è¡Œ */
        .options-container { flex: 1 1 100%; display: none; margin-top: 5px; }
        .schema-item[data-type="select"] .options-container { display: block; }
        .input-options { background-color: #f0f9ff; border-color: #bae6fd; }

        /* æ‹–æ‹½è¦–è¦ºæ•ˆæœ */
        .dragging { opacity: 0.4; border: 2px dashed var(--primary-color); transform: scale(0.98); }
        
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, 40px); gap: 5px; margin-top: 5px; }
        .icon-btn { width: 40px; height: 40px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .icon-btn.selected { border: 2px solid var(--primary-color); background: #eff6ff; }
        #json-editor { width: 100%; height: 300px; font-family: monospace; font-size: 12px; margin-top: 10px; border-radius: 6px; border: 1px solid var(--border-color); }
    </style>
</head>
<body>

<nav>
    <button class="nav-btn active" onclick="showTab('list')">ä»»å‹™çœ‹æ¿</button>
    <button class="nav-btn" onclick="showTab('edit')">ç·¨è¼¯/æ–°å¢</button>
    <button class="nav-btn" onclick="showTab('schema')">å±¬æ€§å»ºæ¨¡</button>
    <button class="nav-btn" onclick="showTab('backup')">å‚™ä»½/æ¢å¾©</button>
</nav>

<div class="container">
    <!-- 1. ä»»å‹™åˆ—è¡¨ -->
    <div id="tab-list" class="tab-content active">
        <div class="toolbar">
            <button class="btn-primary" onclick="prepareNewTask()">+ æ–°å¢ä»»å‹™</button>
            <input type="text" id="search" class="search-box" placeholder="æœå°‹ä»»å‹™å…§å®¹..." oninput="renderTaskList()">
        </div>
        <div class="table-container">
            <table id="task-table">
                <thead id="task-thead"></thead>
                <tbody id="task-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- 2. ä»»å‹™ç·¨è¼¯ -->
    <div id="tab-edit" class="tab-content">
        <h3 id="edit-title" style="margin-top:0">ä»»å‹™ç·¨è¼¯å™¨</h3>
        <form id="task-form"></form>
        <div style="margin-top:20px; display: flex; gap:10px;">
            <button class="btn-primary" style="flex:1" onclick="saveTask()">ä¿å­˜ä¸¦å›åˆ—è¡¨</button>
            <button style="flex:1; border:1px solid #ccc; background:#fff; border-radius:6px;" onclick="showTab('list')">å–æ¶ˆè¿”å›</button>
        </div>
    </div>

    <!-- 3. å±¬æ€§å»ºæ¨¡ -->
    <div id="tab-schema" class="tab-content">
        <div class="toolbar">
            <button class="btn-primary" onclick="addSchemaField()">+ å¢åŠ æ¬„ä½</button>
            <button class="btn-primary" style="background:#059669" onclick="saveSchema()">åŒæ­¥å»ºæ¨¡è¨­å®š</button>
        </div>
        <div id="schema-list"></div>
    </div>

    <!-- 4. å‚™ä»½æ¢å¾© -->
    <div id="tab-backup" class="tab-content">
        <h3 style="margin-top:0">æ•¸æ“šæŒä¹…åŒ–ç®¡ç†</h3>
        <div class="toolbar">
            <button class="btn-primary" onclick="exportJSON()">æ™®é€šä¸‹è¼‰ (JSON)</button>
            <button class="btn-primary" onclick="saveToFileSystem()">æ–‡ä»¶ç³»çµ±ä¿å­˜ (API)</button>
            <button class="btn-primary" style="background:#059669" onclick="importJSON()">åŒ¯å…¥æ•¸æ“š</button>
            <button class="btn-primary" style="background:#64748b" onclick="copyJSON()">è¤‡è£½ä»£ç¢¼</button>
        </div>
        <label style="font-size:13px; color:#666;">å¯¦æ™‚åº•å±¤ JSON (å¯æ‰‹å‹•ä¿®æ”¹å¾Œå¼·åˆ¶æ›´æ–°):</label>
        <textarea id="json-editor"></textarea>
        <button class="btn-primary" style="width:100%; margin-top:10px; background:#ef4444" onclick="forceUpdateJSON()">âš ï¸ å¼·åˆ¶æ›´æ–°æœ¬åœ°å„²å­˜</button>
    </div>
</div>

<script>
    let state = {
        tasks: JSON.parse(localStorage.getItem('pro_tasks') || '[]'),
        schema: JSON.parse(localStorage.getItem('pro_schema') || '[]'),
        editingId: null
    };

    if (state.schema.length === 0) {
        state.schema = [
            {id: 'title', name: 'ä»»å‹™åç¨±', type: 'text', width: 220, required: true},
            {id: 'status', name: 'ç‹€æ…‹', type: 'select', width: 120, options: 'å¾…è¾¦,é€²è¡Œä¸­,å®Œæˆ', required: false},
            {id: 'prio', name: 'æ¨™ç±¤', type: 'icon', width: 80, required: false}
        ];
        saveToLocal();
    }

    const icons = ["ğŸ¯", "âœ…", "ğŸš€", "ğŸ”¥", "âš ï¸", "1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£"];

    function saveToLocal() {
        localStorage.setItem('pro_tasks', JSON.stringify(state.tasks));
        localStorage.setItem('pro_schema', JSON.stringify(state.schema));
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
        if (tabId === 'list') renderTaskList();
        if (tabId === 'schema') renderSchemaEditor();
        if (tabId === 'backup') document.getElementById('json-editor').value = JSON.stringify(state, null, 2);
    }

    // --- ä»»å‹™åˆ—è¡¨ ---
    function renderTaskList() {
        const thead = document.getElementById('task-thead');
        const tbody = document.getElementById('task-tbody');
        const search = document.getElementById('search').value.toLowerCase();

        thead.innerHTML = `<tr>${state.schema.map(f => `<th style="width:${f.width}px">${f.name}</th>`).join('')}<th style="width:60px">åˆªé™¤</th></tr>`;
        
        const filtered = state.tasks.filter(t => Object.values(t).some(v => String(v||"").toLowerCase().includes(search)));
        
        tbody.innerHTML = filtered.map(t => `
            <tr onclick="editTask('${t._uuid}')">
                ${state.schema.map(f => `<td>${t[f.id] || ""}</td>`).join('')}
                <td onclick="event.stopPropagation()"><button class="btn-del" onclick="deleteTask('${t._uuid}')">ğŸ—‘ï¸</button></td>
            </tr>
        `).join('');
    }

    // --- å»ºæ¨¡ç·¨è¼¯ (å„ªåŒ–é‡é») ---
    function renderSchemaEditor() {
        const container = document.getElementById('schema-list');
        container.innerHTML = '';
        state.schema.forEach((field, idx) => {
            const item = document.createElement('div');
            item.className = 'schema-item';
            item.draggable = true;
            item.dataset.type = field.type; // ç”¨æ–¼ CSS åˆ‡æ› Options é¡¯ç¤º
            item.innerHTML = `
                <div class="schema-row">
                    <input type="text" class="form-control input-id" placeholder="ID" value="${field.id}" data-key="id">
                    <input type="text" class="form-control input-name" placeholder="æ¬„ä½é¡¯ç¤ºåç¨±" value="${field.name}" data-key="name">
                    <select class="form-control input-type" data-key="type" onchange="this.closest('.schema-item').dataset.type=this.value">
                        <option value="text" ${field.type=='text'?'selected':''}>ç´”æ–‡å­—</option>
                        <option value="date" ${field.type=='date'?'selected':''}>æ—¥æœŸ</option>
                        <option value="number" ${field.type=='number'?'selected':''}>æ•¸å­—</option>
                        <option value="select" ${field.type=='select'?'selected':''}>ä¸‹æ‹‰é¸å–®</option>
                        <option value="icon" ${field.type=='icon'?'selected':''}>åœ–æ¨™</option>
                    </select>
                    <input type="number" class="form-control input-width" placeholder="å¯¬åº¦" value="${field.width}" data-key="width">
                    <label class="check-required"><input type="checkbox" ${field.required?'checked':''} data-key="required"> å¿…å¡«</label>
                    <button class="btn-del" onclick="removeSchemaField(${idx})">âŒ</button>
                </div>
                <div class="options-container">
                    <input type="text" class="form-control input-options" placeholder="è¼¸å…¥ä¸‹æ‹‰é¸é …ï¼Œä»¥è‹±æ–‡é€—è™Ÿéš”é–‹ (ä¾‹å¦‚: é«˜,ä¸­,ä½)" value="${field.options||''}" data-key="options">
                </div>
            `;
            bindDragEvents(item);
            container.appendChild(item);
        });
    }

    function saveSchema() {
        const items = document.querySelectorAll('.schema-item');
        state.schema = Array.from(items).map(item => {
            const obj = {};
            item.querySelectorAll('[data-key]').forEach(input => {
                obj[input.dataset.key] = input.type === 'checkbox' ? input.checked : 
                                         (input.dataset.key === 'width' ? parseInt(input.value||0) : input.value);
            });
            return obj;
        });
        saveToLocal();
        alert('å»ºæ¨¡å·²ä¿å­˜');
    }

    // --- ä»»å‹™ç·¨è¼¯ ---
    function prepareNewTask() { state.editingId = null; renderTaskForm({}); showTab('edit'); }
    function editTask(uuid) { state.editingId = uuid; renderTaskForm(state.tasks.find(t => t._uuid === uuid)); showTab('edit'); }

    function renderTaskForm(data) {
        const form = document.getElementById('task-form');
        form.innerHTML = state.schema.map(f => {
            const val = data[f.id] || "";
            let ctrl = `<input type="${f.type}" class="form-control" name="${f.id}" value="${val}" ${f.required?'required':''}>`;
            if (f.type === 'select') {
                ctrl = `<select class="form-control" name="${f.id}">
                    <option value="">é¸æ“‡...</option>
                    ${(f.options||"").split(',').map(o => `<option value="${o}" ${val==o?'selected':''}>${o}</option>`).join('')}
                </select>`;
            } else if (f.type === 'icon') {
                ctrl = `<input type="hidden" name="${f.id}" id="i-${f.id}" value="${val}">
                        <div class="icon-grid">${icons.map(i => `<button type="button" class="icon-btn ${val==i?'selected':''}" onclick="setI('${f.id}','${i}',this)">${i}</button>`).join('')}</div>`;
            }
            return `<div class="form-group"><label>${f.name}</label>${ctrl}</div>`;
        }).join('');
    }

    function setI(id, icon, btn) {
        document.getElementById('i-'+id).value = icon;
        btn.parentElement.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function saveTask() {
        const fd = new FormData(document.getElementById('task-form'));
        const obj = state.editingId ? state.tasks.find(t => t._uuid === state.editingId) : { _uuid: crypto.randomUUID() };
        for (let f of state.schema) {
            const v = fd.get(f.id);
            if (f.required && !v) return alert(f.name + ' ç‚ºå¿…å¡«');
            obj[f.id] = v;
        }
        if (!state.editingId) state.tasks.push(obj);
        saveToLocal();
        showTab('list');
    }

    function deleteTask(uuid) { if (confirm('åˆªé™¤ï¼Ÿ')) { state.tasks = state.tasks.filter(t => t._uuid !== uuid); saveToLocal(); renderTaskList(); } }

    // --- æ‹–æ‹½é‚è¼¯ ---
    let dragItem = null;
    function bindDragEvents(el) {
        el.addEventListener('dragstart', () => { dragItem = el; el.classList.add('dragging'); });
        el.addEventListener('dragend', () => el.classList.remove('dragging'));
        el.addEventListener('touchstart', (e) => { dragItem = el; el.classList.add('dragging'); }, {passive:true});
        el.addEventListener('touchend', () => el.classList.remove('dragging'));
        el.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const after = getAfter(e.touches[0].clientY);
            const list = document.getElementById('schema-list');
            if (!after) list.appendChild(dragItem); else list.insertBefore(dragItem, after);
        }, {passive:false});
    }

    document.getElementById('schema-list').addEventListener('dragover', e => {
        e.preventDefault();
        const after = getAfter(e.clientY);
        if (!after) e.currentTarget.appendChild(dragItem); else e.currentTarget.insertBefore(dragItem, after);
    });

    function getAfter(y) {
        const els = [...document.querySelectorAll('.schema-item:not(.dragging)')];
        return els.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- æ•¸æ“šåŠŸèƒ½ ---
    function exportJSON() {
        const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tasks.json'; a.click();
    }
    async function saveToFileSystem() {
        if (!window.showSaveFilePicker) return alert('ç€è¦½å™¨ä¸æ”¯æ´');
        const h = await window.showSaveFilePicker();
        const w = await h.createWritable(); await w.write(JSON.stringify(state)); await w.close();
    }
    function importJSON() {
        const i = document.createElement('input'); i.type = 'file';
        i.onchange = e => {
            const r = new FileReader();
            r.onload = ev => { state = JSON.parse(ev.target.result); saveToLocal(); location.reload(); };
            r.readAsText(e.target.files[0]);
        }; i.click();
    }
    function copyJSON() { navigator.clipboard.writeText(JSON.stringify(state)); alert('å·²è¤‡è£½'); }
    function forceUpdateJSON() {
        try { state = JSON.parse(document.getElementById('json-editor').value); saveToLocal(); location.reload(); } catch(e) { alert('JSON éŒ¯èª¤'); }
    }
    function addSchemaField() { state.schema.push({id:'f'+Date.now(), name:'æ–°æ¬„ä½', type:'text', width:100}); renderSchemaEditor(); }
    function removeSchemaField(idx) { state.schema.splice(idx,1); renderSchemaEditor(); }

    renderTaskList();
</script>
</body>
</html>
